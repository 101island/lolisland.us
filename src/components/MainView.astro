---
import titleSvg from "../assets/title.svg?raw";
import Footer from "./Footer.astro";
import Navbar from "./Navbar.astro";
import Particles from "./Particles.astro";
---

<Navbar />
<div class="particles-container">
  <Particles />
</div>
<div class="halo"></div>
<div class="grain"></div>
<div id="marble-field"></div>
<Footer />

<div class="content">
  <div class="title-card">
    <div class="title-svg-container" set:html={titleSvg} />
  </div>
</div>

<script>
  import { fetchUsers } from "../data/users";
  import { MarbleSystem } from "../utils/marbleSystem";

  const titleCard = document.querySelector(".title-card") as HTMLElement;
  const navbar = document.querySelector(".navbar") as HTMLElement;
  const titleImg = document.querySelector(
    ".title-svg-container svg",
  ) as HTMLElement;

  if (titleImg && titleCard && navbar) {
    const reveal = () => {
      requestAnimationFrame(() => {
        titleCard.style.opacity = "1";
        navbar.style.opacity = "1";
      });
    };

    reveal();
  }

  const field = document.getElementById("marble-field");

  if (field) {
    let zoomLevel = 1.0;

    // 初始化弹珠系统
    const marbleSystem = new MarbleSystem({
      container: field,
      fieldWidth: window.innerWidth,
      fieldHeight: window.innerHeight,
    });

    // 启动动画循环
    marbleSystem.start();

    // 获取并添加用户弹珠
    fetchUsers()
      .then((users) => {
        marbleSystem.addMarbles(users);
      })
      .catch((err) => console.error("Failed to fetch users:", err));

    // Debug Info Loop
    // Debug Mode Check
    const urlParams = new URLSearchParams(window.location.search);
    const isDebug = urlParams.get("debug") === "true";

    if (isDebug) {
      // 1. Create and inject Debug Canvas
      const debugCanvas = document.createElement("canvas");
      debugCanvas.id = "debug-velocity-canvas";
      document.body.appendChild(debugCanvas);

      // 2. Create and inject Debug Info Panel
      const debugEl = document.createElement("div");
      debugEl.id = "debug-info";
      debugEl.innerHTML = "Initializing Gyro...";
      document.body.appendChild(debugEl);

      // 3. Enable Debug Mode in System
      // We must set debug mode BEFORE starting the loop if we want it to pick up the canvas immediately,
      // or set it now. The marbleSystem.setDebugMode will find the canvas by ID.
      marbleSystem.setDebugMode(true);

      // 4. Start Debug Info Loop
      const updateDebug = () => {
        const info = marbleSystem.getAllDebugInfo();
        debugEl.innerHTML = `
            <div>MActive: ${info.motionActive}</div>
            <div>MSupported: ${info.motionSupported}</div>
            <div>MAX: ${info.motionAx}</div>
            <div>MAY: ${info.motionAy}</div>
            <div>MAForce: ${Math.hypot(parseFloat(info.motionAx), parseFloat(info.motionAy)).toFixed(2)}</div>
            <div>Active: ${info.active}</div>
            <div>Supported: ${info.supported}</div>
            <div>AX: ${info.ax}</div>
            <div>AY: ${info.ay}</div>
            <div>Alpha: ${info.alpha}</div>
            <div>Beta: ${info.beta}</div>
            <div>Gamma: ${info.gamma}</div>
            <div>Force: ${Math.hypot(parseFloat(info.ax), parseFloat(info.ay)).toFixed(2)}</div>
            <div>SubSteps: ${info.subSteps}</div>
            <div>T: ${info.kineticEnergy.toFixed(2)}</div>
            <div>MinSpeed: ${(info.minSpeed ?? 0).toFixed(2)}</div>
          `;
        requestAnimationFrame(updateDebug);
      };
      updateDebug();
    }

    // 缩放功能
    const zoomInBtn = document.getElementById("zoom-in");
    const zoomOutBtn = document.getElementById("zoom-out");

    if (zoomInBtn) {
      zoomInBtn.addEventListener("click", () => {
        zoomLevel = Math.min(zoomLevel + 0.1, 2.0); // Cap max zoom
        marbleSystem.updateMarbleSize(zoomLevel);
      });
    }

    if (zoomOutBtn) {
      zoomOutBtn.addEventListener("click", () => {
        zoomLevel = Math.max(zoomLevel - 0.1, 0.5); // Cap min zoom
        marbleSystem.updateMarbleSize(zoomLevel);
      });
    }

    // Toggle Collisions
    window.addEventListener("toggle-collision", ((e: CustomEvent) => {
      marbleSystem.setCollisions(e.detail.enabled);
    }) as EventListener);

    // Toggle Title
    let titleTimeout: number;
    window.addEventListener("toggle-title", ((e: CustomEvent) => {
      const titleCard = document.querySelector(".title-card") as HTMLElement;
      if (titleCard) {
        clearTimeout(titleTimeout);
        if (e.detail.enabled) {
          titleCard.style.display = "inline-block";
          // Force Reflow
          void titleCard.offsetWidth;
          titleCard.style.opacity = "1";
          titleCard.style.pointerEvents = "auto";
        } else {
          titleCard.style.opacity = "0";
          titleCard.style.pointerEvents = "none";
          titleTimeout = setTimeout(() => {
            titleCard.style.display = "none";
          }, 500) as unknown as number;
        }
      }
    }) as EventListener);

    // Toggle Marbles
    let marbleTimeout: number;
    window.addEventListener("toggle-marbles", ((e: CustomEvent) => {
      const marbleField = document.getElementById("marble-field");
      if (marbleField) {
        clearTimeout(marbleTimeout);

        if (e.detail.enabled) {
          // 1. Resume physics immediately (so they move while fading in)
          marbleSystem.start();
          // 2. Show element
          marbleField.style.display = "block";
          // 3. Force reflow for transition
          void marbleField.offsetWidth;
          // 4. Fade in
          marbleField.style.opacity = "1";
        } else {
          // 1. Fade out
          marbleField.style.opacity = "0";
          // 2. Wait for transition, then stop physics & hide
          marbleTimeout = setTimeout(() => {
            marbleSystem.stop();
            marbleField.style.display = "none";
          }, 500) as unknown as number;
        }
      }
    }) as EventListener);

    // Toggle Background
    let bgTimeout: number;
    window.addEventListener("toggle-background", ((e: CustomEvent) => {
      const bgElements = [
        document.querySelector(".halo"),
        document.querySelector(".grain"),
        document.querySelector(".particles-container"),
      ] as HTMLElement[];

      bgElements.forEach((el) => {
        if (el) {
          // Ensure transition is active (robustness against CSS issues)
          el.style.transition = "opacity 0.5s ease";

          if (e.detail.enabled) {
            el.style.display = "block";
            // Force Reflow
            void el.offsetWidth;
            el.style.opacity = "1";
          } else {
            el.style.opacity = "0";
          }
        }
      });

      if (!e.detail.enabled) {
        bgTimeout = setTimeout(() => {
          bgElements.forEach((el) => {
            if (el) el.style.display = "none";
          });
        }, 500) as unknown as number;
      }
    }) as EventListener);
  }
</script>

<style>
  .grain {
    position: fixed;
    inset: -30%;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.16'/%3E%3C/svg%3E");
    mix-blend-mode: screen;
    pointer-events: none;
    animation: drift 20s linear infinite;
    z-index: 1;
    transition: opacity 0.5s ease;
  }

  .particles-container {
    transition: opacity 0.5s ease;
  }

  .halo {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    transition: opacity 0.5s ease;
  }

  .halo::before,
  .halo::after {
    content: "";
    position: absolute;
    inset: -20%;
    background: conic-gradient(
      from 120deg,
      rgba(124, 251, 255, 0.25),
      rgba(255, 127, 209, 0.35),
      rgba(255, 209, 102, 0.2),
      rgba(124, 251, 255, 0.25)
    );
    filter: blur(120px);
    opacity: 0.55;
    animation: spin 32s linear infinite;
  }

  .halo::after {
    animation-direction: reverse;
    animation-duration: 46s;
    opacity: 0.38;
  }

  .content {
    position: relative;
    z-index: 5;
    display: grid;
    place-items: center;
    min-height: 100vh;
    min-height: 100dvh;
    padding: 2rem;
    text-align: center;
    pointer-events: none;
  }

  .title-card {
    padding: 1.8rem 2.4rem;
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    background: linear-gradient(
      145deg,
      rgba(255, 255, 255, 0.12),
      rgba(255, 255, 255, 0.04)
    );
    backdrop-filter: blur(6px);
    box-shadow:
      0 0 0 1px rgba(255, 255, 255, 0.08),
      0 10px 40px rgba(0, 0, 0, 0.5);
    display: inline-block;
    width: auto;
    max-width: 80vw;
    position: relative;
    overflow: hidden;
    pointer-events: auto;
    z-index: 6;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .navbar {
    opacity: 0;
    transition: opacity 1s ease;
  }

  .title-card::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 22px;
    background: linear-gradient(
      120deg,
      rgba(124, 251, 255, 0.06),
      rgba(255, 127, 209, 0.05),
      rgba(255, 209, 102, 0.05)
    );
    z-index: -1;
  }

  h1 {
    margin: 0 0 0.35rem 0;
    font-size: clamp(2rem, 7vw, 4.4rem);
    line-height: 1;
    letter-spacing: 0.07em;
    text-transform: none;
    color: var(--text);
    text-shadow:
      0 0 18px rgba(124, 251, 255, 0.55),
      0 6px 22px rgba(0, 0, 0, 0.35);
  }

  .title-svg-container {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
  }

  .title-svg-container :global(svg) {
    width: 100%;
    height: auto;
    display: block;
  }

  .tagline {
    margin: 0.4rem 0 0;
    font-size: clamp(1rem, 2.4vw, 1.35rem);
    color: rgba(247, 247, 255, 0.82);
    letter-spacing: 0.06em;
  }

  #marble-field {
    position: fixed;
    inset: 0;
    overflow: hidden;
    z-index: 2;
    opacity: 1; /* Default visible */
    transition: opacity 0.5s ease;
  }

  :global(#debug-velocity-canvas) {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
  }

  :global(#debug-info) {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #0f0;
    font-family: monospace;
    padding: 8px;
    border-radius: 4px;
    z-index: 9999;
    font-size: 12px;
    pointer-events: none;
    display: block; /* Visible when added */
  }

  :global(.marble-wrapper) {
    position: absolute;
    will-change: transform, width, height;
    transition:
      opacity 1s ease,
      width 0.3s ease,
      height 0.3s ease;
  }

  :global(.marble-wrapper:hover) {
    z-index: 10;
  }

  :global(.marble) {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
    border-radius: 50%;
    isolation: isolate;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    margin: 0;
    box-shadow:
      inset -2px -2px 6px rgba(0, 0, 0, 0.6),
      inset 2px 2px 4px rgba(255, 255, 255, 0.4),
      0 2px 8px rgba(0, 0, 0, 0.4);
    /* backdrop-filter: blur(4px); -- Removed for performance */
    overflow: hidden;
    transform: translate3d(0, 0, 0);
    will-change: transform;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  :global(.marble::after) {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(
      ellipse at 30% 25%,
      rgba(255, 255, 255, 0.85) 0%,
      rgba(255, 255, 255, 0) 45%
    );
    mix-blend-mode: overlay;
    pointer-events: none;
  }

  :global(.marble:hover) {
    transform: scale(1.15) translateY(-2px);
    box-shadow:
      inset -2px -2px 6px rgba(0, 0, 0, 0.5),
      inset 2px 2px 6px rgba(255, 255, 255, 0.5),
      0 4px 12px rgba(0, 0, 0, 0.5);
    filter: brightness(1.05);
  }

  :global(.marble-label) {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 8px;
    padding: 4px 8px;
    border-radius: 0;
    background: rgba(5, 5, 16, 0.55);
    color: #fefefe;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-align: center;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
    /* backdrop-filter: blur(6px); -- Removed for performance */
    pointer-events: none;
  }

  @media (max-width: 720px) {
    .title-card {
      width: auto;
      max-width: 82vw;
      padding: 1.6rem 1.8rem;
    }

    h1 {
      font-size: clamp(1.8rem, 10vw, 3rem);
      letter-spacing: 0.05em;
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes drift {
    0% {
      transform: translate3d(0, 0, 0) scale(1);
    }

    50% {
      transform: translate3d(-2%, -2%, 0) scale(1.02);
    }

    100% {
      transform: translate3d(0, 0, 0) scale(1);
    }
  }
</style>
