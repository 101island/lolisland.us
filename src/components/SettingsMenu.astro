<div class="settings-container">
  <div class="menu-items" id="settings-menu">
    <div class="zoom-controls">
      <button id="zoom-in" aria-label="Zoom In">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
      <button id="zoom-out" aria-label="Zoom Out">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>

    <div class="separator"></div>

    <label class="toggle-switch">
      <input type="checkbox" id="title-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Title</span>
    </label>

    <label class="toggle-switch">
      <input type="checkbox" id="marbles-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Marbles</span>
    </label>

    <label class="toggle-switch" id="collision-container">
      <input type="checkbox" id="collision-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Collisions</span>
    </label>

    <label class="toggle-switch" id="device-motion-container">
      <input type="checkbox" id="device-motion-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Motion</span>
    </label>

    <label class="toggle-switch" id="device-orientation-container">
      <input type="checkbox" id="device-orientation-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Orientation</span>
    </label>

    <label class="toggle-switch">
      <input type="checkbox" id="background-toggle" checked />
      <span class="slider"></span>
      <span class="label-text">Background</span>
    </label>
  </div>

  <!-- Toggle Button -->
  <button id="settings-toggle" aria-label="Settings">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="12" cy="12" r="3"></circle>
      <path
        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
      ></path>
    </svg>
  </button>
</div>

<script>
  const toggleBtn = document.getElementById("settings-toggle");
  const menu = document.getElementById("settings-menu");

  // Toggle Elements
  const toggles = {
    collision: document.getElementById("collision-toggle") as HTMLInputElement,
    title: document.getElementById("title-toggle") as HTMLInputElement,
    marbles: document.getElementById("marbles-toggle") as HTMLInputElement,
    background: document.getElementById(
      "background-toggle",
    ) as HTMLInputElement,
    deviceMotion: document.getElementById(
      "device-motion-toggle",
    ) as HTMLInputElement,
    deviceOrientation: document.getElementById(
      "device-orientation-toggle",
    ) as HTMLInputElement,
  };

  // Helper to dispatch event
  const emit = (name: string, enabled: boolean) => {
    window.dispatchEvent(new CustomEvent(name, { detail: { enabled } }));
  };

  // Bind events
  if (toggles.collision) {
    toggles.collision.addEventListener("change", (e) =>
      emit("toggle-collision", (e.target as HTMLInputElement).checked),
    );
  }
  if (toggles.deviceMotion) {
    toggles.deviceMotion.addEventListener("change", (e) =>
      emit("toggle-device-motion", (e.target as HTMLInputElement).checked),
    );
  }
  if (toggles.deviceOrientation) {
    toggles.deviceOrientation.addEventListener("change", (e) =>
      emit("toggle-device-orientation", (e.target as HTMLInputElement).checked),
    );
  }
  if (toggles.title) {
    toggles.title.addEventListener("change", (e) => {
      const target = e.target as HTMLInputElement;
      emit("toggle-title", target.checked);

      // Debounce: Disable for 1s
      target.disabled = true;
      const parent = target.parentElement;
      if (parent) parent.classList.add("disabled");

      setTimeout(() => {
        target.disabled = false;
        if (parent) parent.classList.remove("disabled");
      }, 500);
    });
  }
  if (toggles.background) {
    toggles.background.addEventListener("change", (e) => {
      const target = e.target as HTMLInputElement;
      emit("toggle-background", target.checked);

      // Debounce: Disable for 1s
      target.disabled = true;
      const parent = target.parentElement;
      if (parent) parent.classList.add("disabled");

      setTimeout(() => {
        target.disabled = false;
        if (parent) parent.classList.remove("disabled");
      }, 500);
    });
  }

  // Special handling for Marbles toggle (controls collision visibility)
  if (toggles.marbles) {
    toggles.marbles.addEventListener("change", (e) => {
      const target = e.target as HTMLInputElement;
      emit("toggle-marbles", target.checked);

      // Debounce: Disable for 0.5s
      target.disabled = true;
      const parent = target.parentElement;
      if (parent) parent.classList.add("disabled");

      setTimeout(() => {
        target.disabled = false;
        if (parent) parent.classList.remove("disabled");
      }, 500);

      // logic to disable/enable collision toggle
      if (toggles.collision) {
        toggles.collision.disabled = !target.checked;
        const container = toggles.collision.parentElement;
        if (container) {
          container.classList.toggle("disabled", !target.checked);
        }
      }
    });
  }

  if (toggleBtn && menu) {
    toggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menu.classList.toggle("active");
    });

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
      if (
        !menu.contains(e.target as Node) &&
        !toggleBtn.contains(e.target as Node)
      ) {
        menu.classList.remove("active");
      }
    });
  }
</script>

<style>
  .settings-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* Align to right */
  }

  /* Menu Items (Popup) */
  .menu-items {
    position: absolute;
    bottom: 120%; /* Above the button */
    right: 0; /* Align to right edge */
    transform: translateY(10px);
    display: flex;
    flex-direction: column; /* Vertical stack */
    gap: 0.8rem;
    padding: 0.6rem; /* Reduced padding */
    background: linear-gradient(
      145deg,
      rgba(255, 255, 255, 0.12),
      rgba(255, 255, 255, 0.04)
    ); /* Translucent gradient */
    backdrop-filter: blur(6px); /* Glass blur effect */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
    z-index: 100;
  }

  .menu-items.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .zoom-controls {
    display: flex;
    flex-direction: row;
    gap: 0.8rem;
  }

  /* Button Styles (Shared) */
  button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    background: linear-gradient(
      145deg,
      rgba(255, 255, 255, 0.12),
      rgba(255, 255, 255, 0.04)
    );
    box-shadow:
      0 0 0 1px rgba(255, 255, 255, 0.08),
      0 4px 12px rgba(0, 0, 0, 0.2);
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition:
      transform 0.1s ease,
      background 0.2s ease;
  }

  button:hover {
    background: linear-gradient(
      145deg,
      rgba(255, 255, 255, 0.16),
      rgba(255, 255, 255, 0.08)
    );
    transform: translateY(-2px);
  }

  button:active {
    transform: translateY(0);
  }

  button svg {
    width: 24px;
    height: 24px;
    opacity: 0.8;
  }

  .separator {
    width: 100%; /* Full width separator */
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 0;
  }

  /* Toggle Switch */
  .toggle-switch {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    user-select: none;
    padding: 0 0.5rem; /* Add padding */
    height: 48px; /* Match button height */
    transition: opacity 0.3s;
  }

  .toggle-switch.disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .toggle-switch input {
    display: none;
  }

  .slider {
    position: relative;
    width: 40px;
    height: 22px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    transition: 0.3s;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .slider:before {
    content: "";
    position: absolute;
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 2px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  input:checked + .slider {
    background: rgba(124, 251, 255, 0.3);
    border-color: rgba(124, 251, 255, 0.4);
  }

  input:checked + .slider:before {
    transform: translateX(18px);
    background: #7cfbff;
    box-shadow: 0 0 10px rgba(124, 251, 255, 0.6);
  }

  .label-text {
    font-weight: 500;
    letter-spacing: 0.02em;
  }
</style>
